// HTML5QrcodeScanner (might throw an error msg for instructions.html & socmaps.html as the id "qr-reader" only exists in index.html - small matter)
const html5QrcodeScanner = new Html5QrcodeScanner(
    "qr-reader", { fps: 10, qrbox: 250, rememberLastUsedCamera: false });

// Process QR Code using HTML5QRcodeScanner
function onScanSuccess(decodedText, decodedResult) {

    // Close the QR code scanning after the result is retrieved, do so by using javascript to trigger/click the "Stop Scanning" btn
    $("#html5-qrcode-button-camera-stop").trigger("click");

    // Close the QR Scanner modal-pop automatically
    $('#qrScannerModal').modal('hide');

    // Handle on success condition with the decoded text or result
    console.log(`Scan result: ${decodedText}`, decodedResult);

    // Send the data to the Django view using AJAX POST
    const csrfToken = $('[name="csrfmiddlewaretoken"]').attr('value');

    // // Send the data to the Django view using AJAX POST
    $.ajax({
        type: 'POST',
        url: "/scan_qr_validation/",
        dataType: 'json',
        headers: {
            "X-CSRFToken": csrfToken
        },
        data: {
            'decodedText': decodedText
        },
        success: function (response, status, xhr) {
            const result = response['success'];
            if (result) {

                // Display success alert
                const newLocation = response['locationName'];
                const newFact = response['locationFact'];
                const newBadge = response['locationBadge'];

                Swal.fire({
                    title: "Nice, you have collected a badge! This is the " + newLocation,
                    text: "Cool Fact: " + newFact,
                    iconHtml: '<img src="' + "/media/" + newBadge + '"' +' width="100"' + ' height="100"' + '>',
                    customClass: {
                        icon: 'no-border'
                    }
                })

                // Change the content of the scanned location to their respective badge as bg image, remove the blur effect and remove caption
                const badgeImageUrl = "/media/" + newBadge;
                document.getElementById(newLocation).style.backgroundImage = `url('${badgeImageUrl}')`;
                document.getElementById(newLocation).style.backgroundSize = "100px";
                document.getElementById(newLocation).style.backgroundPosition = "center";
                document.getElementById(newLocation).getElementsByClassName("blur")[0].style.backdropFilter = "blur(0)";
                document.getElementById(newLocation).getElementsByClassName("blur")[0].style.background = "rgba(255, 255, 255, 0.2)";
                document.getElementById(newLocation).nextElementSibling.innerHTML = "";

                // Run completedStatus() to determine if user has completed the game after this scan
                completedStatus();

            }
            else {
                const errMsg = response['errorMsg'];

                // Display invalid QR Code alert
                if (errMsg === "INVALID") {
                    console.log("Invalid QR! Only scan QR Codes generated by NUS SoC Scavenger Hunt Web App!");
                    Swal.fire({
                        title: "Oops!",
                        text: "Invalid QR! Only scan QR Codes generated by NUS SoC Scavenger Hunt Web App!",
                        icon: 'error'
                    })
                }

                // Display duplicate QR Code alert
                if (errMsg === "EXIST") {
                    const location = response['locationName'];
                    console.log("QR Code for this location, '" + location + "' already scanned! Please scan other locations!");
                    Swal.fire({
                        title: "Already Scanned!",
                        text: "QR Code for this location, '" + location + "' already scanned! Please scan other locations!",
                        icon: 'warning'
                    })
                }
            }
        },
        // a failure callback that gets invoked in case there is any error while making the request
        error: function (xhr, status, error) {
            console.log(xhr.responseText);
        }
    });

}

// Style all the icons in cookie "scannedLocationListCookie" (to run this everytime web app loads)
function scannedLocationsStyle() {
    // Get the value of cookie "scannedLocationListCookie", note it returns a string representation, [\"location_1\"\054 \"location_2\"..]
    let scannedLocationListCookieValue = Cookies.get('scannedLocationListCookie');

    // Only process accordingly when there are values in the cookie "scannedLocationListCookie"
    if (scannedLocationListCookieValue) {
        // Convert the string representation to list
        scannedLocationListCookieValue = JSON.parse(scannedLocationListCookieValue.replaceAll("\\054", ",").replaceAll("\\", ""));
        console.log(scannedLocationListCookieValue);

        // Change the CSS for all the locations that are already scanned (loop through the list), and replace the background-image to their respective badges
        for (let i = 0; i < scannedLocationListCookieValue.length; i++) {
            
            // Retrieve the location name and badge url
            let location_name = Object.keys(scannedLocationListCookieValue[i])[0]
            let location_badge = "/media/" + Object.values(scannedLocationListCookieValue[i])[0];
            // Change the content of the scanned location to their respective badge as bg image, remove the blur effect and remove caption
            document.getElementById(location_name).style.backgroundImage = `url('${location_badge}')`;
            document.getElementById(location_name).style.backgroundSize = "100px";
            document.getElementById(location_name).style.backgroundPosition = "center";
            document.getElementById(location_name).getElementsByClassName("blur")[0].style.backdropFilter = "blur(0)";
            document.getElementById(location_name).getElementsByClassName("blur")[0].style.background = "rgba(255, 255, 255, 0.2)";
            document.getElementById(location_name).nextElementSibling.innerHTML = "";
        }
    }
}

// Determine if user completed the game by checking cookie "completedStatusCookie" & style the web app accordingly (to run this everytime web app loads)
function completedStatus() {
    // Get the value of cookie "completedStatusCookie"
    let completedStatusCookieValue = Cookies.get('completedStatusCookie');
    if (completedStatusCookieValue === 'yes') {
        // Show the hidden django-social-share modal pop-up
        console.log("User has successfully completed NUS Soc Scavenger Hunt game 2023!");
        $('#socialShareModal').modal('show');
    }
}

// Close the scanner
function closeScannerModal() {
    // Stop the scan
    $("#html5-qrcode-button-camera-stop").trigger("click");
}

// Remove the original styling and added custom CSS Styling
document.querySelector('#qr-reader').removeAttribute('style');

// Render the QR Scanner
html5QrcodeScanner.render(onScanSuccess);